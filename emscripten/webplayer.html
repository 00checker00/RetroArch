<!doctype html>

<html lang="en">
<head>
   <meta charset="utf-8">
   <title>RetroArch Web Player</title>
   <script type="text/javascript" src="browserfs.js"></script>

   <style>
      .webplayer { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
      textarea.webplayer { border: 0px; font-family: 'Share Tech Mono'; font-size: 12px; width: 100%; overflow:hide; resize:none; color:black; }
      div.webplayer, h1 { text-align: left; }
      div.canvas_border { background-color:gray; width:800px; height:600px; margin-left: auto; margin-right: auto; }
      canvas.webplayer { border: 0px none; }
   </style>
</head>
<body>
   <hr/>
   <div class="webplayer_border" id="canvas_div" style="display: none">
      <canvas class="webplayer" id="canvas" tabindex="1" oncontextmenu="event.preventDefault()"></canvas>
   </div>
   <hr/>
   <div class="webplayer webplayer_border" id="openrom">
      <button id="btnLoad" onclick="document.getElementById('rom').click()">Upload Content</button>
      <input style="display: none" type="file" id="rom" name="upload" onclick="document.getElementById('btnLoad').click();" onchange="selectFiles(event.target.files)" multiple />
      <button id="btnStart" onclick="startRetroArch()">Start RetroArch</button>
   </div>
   <hr/>
   <div class="webplayer">
      <input type="checkbox" id="resize"><label for="resize">Resize canvas</label>
      <input type="checkbox" id="pointerLock" checked><label for="pointerLock">Lock/hide mouse pointer</label>
      <input type="button" value="Fullscreen" onclick="Module.requestFullScreen(document.getElementById('pointerLock').checked, document.getElementById('resize').checked)"><br>
      <input type="checkbox" id="vsync"><label for="vsync" id="vsync-label">Enable V-sync (can only be done before loading game)</label><br>
      <input type="checkbox" id="sdl2"><label for="sdl2" id="sdl2-label">Enable SDL2</label><br>
      <input type="textbox" id="latency" size="3" maxlength="3" value="96"> <label for="latency" id="latency-label">Audio latency (ms) (increase if you hear pops at fullspeed, can only be done before loading game)</label>
   </div>

   <hr/>
   <textarea class="webplayer" id="output" rows="15"></textarea>
   <hr>
</body>
</html>
<script type='text/javascript'>
   var count = 0;

   function setupFileSystem()
   {
      if(localStorage.getItem("fs_inited")!="true")
      {
         var lsfs = new BrowserFS.FileSystem.LocalStorage();
         BrowserFS.initialize(lsfs);
         var BFS = new BrowserFS.EmscriptenFS();
   
         FS.mount(BFS, {root: '/'}, '/home');
   
         console.log('WEBPLAYER: Filesystem initialized');
      }
      else
      {
         console.log('WEBPLAYER: Filesystem already initialized');
      }
   }


   function setupFolderStructure()
   {
      FS.createPath('/', '/home/web_user', true, true);
      FS.createPath('/', '/home/web_user/.config', true, true);
      FS.createPath('/', '/home/web_user/.config/retroarch', true, true);
      FS.createPath('/', '/home/web_user/content', true, true);
      FS.createPath('/', '/home/web_user/saves', true, true);
      FS.createPath('/', '/home/web_user/states', true, true);
      FS.createPath('/', '/home/web_user/system', true, true);
   }

   function stat(path)
   {
      try{
         FS.stat(path);
      }
      catch(err)
      {
         console.log("WEBPLAYER: file " + path + " doesn't exist");
         return false;
      }
      return true;
   }

   function startRetroArch()
   {
      document.getElementById('canvas_div').style.display = 'block';
      document.getElementById('vsync').disabled = true;
      document.getElementById('vsync-label').style.color = 'gray';
      document.getElementById('latency').disabled = true;
      document.getElementById('latency-label').style.color = 'gray';

      setupFileSystem();
      setupFolderStructure();
      cfgFile = '/home/web_user/.config/retroarch/retroarch.cfg'

      if (!stat(cfgFile))
      {
         console.log ("WEBPLAYER: first run, setting defaults");
         var config = 'input_player1_select = shift\n';
         var latency = parseInt(document.getElementById('latency').value, 10);
         if (isNaN(latency)) latency = 96;
         config += 'audio_latency = ' + latency + '\n'
         if (document.getElementById('vsync').checked)
            config += 'video_vsync = true\n';
         else
         config += 'video_vsync = false\n';
         config += 'system_directory = /home/web_user/system/\n';
         config += 'savefile_directory = /home/web_user/saves/\n';
         config += 'savestate_directory = /home/web_user/saves/\n';
         config += 'rgui_browser_directory = /home/web_user/content/\n';

         FS.writeFile(cfgFile, config);
      }
      else 
      {
         console.log ("WEBPLAYER: loading config from " + cfgFile);
      }
      Module['callMain'](Module['arguments']);
   }
   
   function selectFiles(files)
   {
      count = files.length;

      for (var i = 0; i < files.length; i++) 
      {
         filereader = new FileReader();
         filereader.file_name = files[i].name;
         filereader.readAsArrayBuffer(files[i]);
         filereader.onload = function(){uploadData(this.result, this.file_name)};
      }
   }

   function uploadData(data,name)
   {
      var dataView = new Uint8Array(data);
      FS.createDataFile('/', name, dataView, true, false);

      var data = FS.readFile(name,{ encoding: 'binary' });
      FS.writeFile('/home/web_user/content/' + name, data ,{ encoding: 'binary' });
      FS.unlink(name);

   }

   var Module = 
   {
      noInitialRun: true,
      arguments: ["-v", "--menu"],
      preRun: [],
      postRun: [],
      print: (function() 
      {
         var element = document.getElementById('output');
         element.value = ''; // clear browser cache
         return function(text) 
         {
            text = Array.prototype.slice.call(arguments).join(' ');
            element.value += text + "\n";
            element.scrollTop = 99999; // focus on bottom
         };
      })(),

      printErr: function(text)
      {
         var text = Array.prototype.slice.call(arguments).join(' ');
         var element = document.getElementById('output');
         element.value += text + "\n";
         element.scrollTop = 99999; // focus on bottom
      },
      canvas: document.getElementById('canvas'),

      totalDependencies: 0,
      monitorRunDependencies: function(left) 
      {
         this.totalDependencies = Math.max(this.totalDependencies, left);
      }
   };

</script>
<script type="text/javascript" src="browserfs.js"></script>
<script type="text/javascript" src="gambatte.js"></script>